#!/bin/bash

# Install tmux plugins via TPM
if [ -x "${HOME}/.tmux/plugins/tpm/bin/install_plugins" ]; then
  echo "Installing tmux plugins..."
  "${HOME}/.tmux/plugins/tpm/bin/install_plugins"
fi

{{ if .codespaces -}}
if [ -n "${GH_GH_PAT}" ]; then
  echo "Set chezmoi remote to use GH_GH_PAT"
  chezmoi git -- remote set-url --push origin https://username:"${GH_GH_PAT}"@github.com/ekroon/dotfiles
else
  echo "Skipping setting chezmoi remote to use GH_GH_PAT"
fi

# Install mise tools (config is generated by chezmoi templates from .chezmoidata.yaml)
if command -v mise >/dev/null; then
  echo "Installing mise tools for repo: {{ .repo }}"
  mise install
else
  echo "mise not available; skipping tool install"
fi
{{ end }}

{{ if not .codespaces -}}
# Install gh-not extension and terminal-notifier (Darwin only, idempotent)
if command -v gh >/dev/null 2>&1; then
  if ! gh extension list 2>/dev/null | grep -q 'nobe4/gh-not'; then
    echo "Installing gh-not extension..."
    gh extension install nobe4/gh-not
  fi
fi

if command -v brew >/dev/null 2>&1; then
  if ! command -v terminal-notifier >/dev/null 2>&1; then
    echo "Installing terminal-notifier..."
    brew install terminal-notifier
  fi
fi
{{ end -}}

# Check if ${ATUIN_USERNAME}, ${ATUIN_PASSWORD} and ${ATUIN_KEY} are set
if [ -z "${ATUIN_USERNAME}" ] || [ -z "${ATUIN_PASSWORD}" ] || [ -z "${ATUIN_KEY}" ]; then
  echo "ATUIN_USERNAME, ATUIN_PASSWORD and ATUIN_KEY must be set for atuin initialization"
else
  echo "Initializing atuin"
  atuin login -u "${ATUIN_USERNAME}" -p "${ATUIN_PASSWORD}" -k "${ATUIN_KEY}"
  atuin sync
fi
