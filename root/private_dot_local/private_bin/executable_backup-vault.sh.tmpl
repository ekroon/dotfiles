#!/bin/bash
set -euo pipefail

# Set PATH for LaunchAgent execution (includes Homebrew and common locations)
export PATH="/opt/homebrew/bin:/usr/local/bin:{{ .chezmoi.homeDir }}/.local/bin:/usr/bin:/bin:/usr/sbin:/sbin:$PATH"

# Configuration
VAULT_PATH="{{ .chezmoi.homeDir }}/Library/Mobile Documents/iCloud~md~obsidian/Documents/MainVault"
LOCAL_REPO="$HOME/.vault-backups"
PASSWORD_FILE="$HOME/.config/restic/password"
LOG_DIR="$HOME/.local/log"
ICLOUD_DIR="$HOME/Library/Mobile Documents/com~apple~CloudDocs/Backups/Obsidian"
ICLOUD_REPO="$ICLOUD_DIR/restic"
ICLOUD_PASSWORD_FILE="$ICLOUD_DIR/restic-password"

# Defaults
LOCAL=false
REMOTE=false
ICLOUD=false
TAG="manual"
LIST=false
CHECK=false
COMMAND_ARGS=()
SCOPE_SET=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --remote)
            REMOTE=true
            SCOPE_SET=true
            shift
            ;;
        --local)
            LOCAL=true
            SCOPE_SET=true
            shift
            ;;
        --icloud)
            ICLOUD=true
            SCOPE_SET=true
            shift
            ;;
        --tag)
            TAG="$2"
            shift 2
            ;;
        --list)
            LIST=true
            shift
            ;;
        --check)
            CHECK=true
            shift
            ;;
        --)
            shift
            COMMAND_ARGS=("$@")
            break
            ;;
        *)
            echo "Unknown option: $1" >&2
            exit 1
            ;;
    esac
done

if [[ "$SCOPE_SET" == false ]]; then
    LOCAL=true
fi

notify_error() {
    local message="$1"
    echo "Error: $message" >&2
    # Use environment variable to safely pass message to osascript without shell injection
    BACKUP_NOTIFY_MSG="$message" nohup osascript -e 'display notification (system attribute "BACKUP_NOTIFY_MSG") with title "Vault Backup" sound name "Basso"' &>/dev/null &
}

# Run a restic backup and detect permission errors.
# Returns 0 on success, 1 on permission error (with notification), or the restic exit code.
run_backup() {
    local repo="$1"
    shift
    local output
    set +e
    output=$(restic -r "$repo" --password-file "$PASSWORD_FILE" backup "$VAULT_PATH" "$@" 2>&1)
    local rc=$?
    set -e
    echo "$output"
    if echo "$output" | grep -qi "operation not permitted"; then
        notify_error "Backup failed: grant Full Disk Access to your terminal/app in System Settings â†’ Privacy & Security"
        return 1
    fi
    return "$rc"
}

verify_icloud_password_key() {
    if [[ ! -f "$ICLOUD_PASSWORD_FILE" ]]; then
        echo "Warning: iCloud password file not found at $ICLOUD_PASSWORD_FILE, cannot verify iCloud key" >&2
        return 1
    fi

    if restic -r "$ICLOUD_REPO" --password-file "$ICLOUD_PASSWORD_FILE" snapshots >/dev/null 2>&1; then
        echo "iCloud password key verified."
        return 0
    fi

    if restic key add --help 2>/dev/null | grep -q -- '--new-password-file'; then
        echo "Adding iCloud password key..."
        restic -r "$ICLOUD_REPO" --password-file "$PASSWORD_FILE" key add --new-password-file "$ICLOUD_PASSWORD_FILE"
        if restic -r "$ICLOUD_REPO" --password-file "$ICLOUD_PASSWORD_FILE" snapshots >/dev/null 2>&1; then
            echo "iCloud password key verified."
            return 0
        fi
        echo "Warning: Failed to verify iCloud password key after adding" >&2
        return 1
    fi

    echo "Warning: restic does not support --new-password-file; skipping iCloud key add" >&2
    return 1
}

# List snapshots and exit
if [[ "$LIST" == true ]]; then
    if [[ "$LOCAL" == true ]]; then
        echo "Local snapshots:"
        restic -r "$LOCAL_REPO" --password-file "$PASSWORD_FILE" snapshots
    fi
    
    if [[ "$REMOTE" == true ]]; then
        B2_ENV="$HOME/.config/restic/b2-env"
        if [[ -f "$B2_ENV" ]]; then
            source "$B2_ENV"
            if [[ -n "${B2_ACCOUNT_ID:-}" && -n "${B2_ACCOUNT_KEY:-}" && -n "${RESTIC_REPOSITORY_REMOTE:-}" ]]; then
                echo ""
                echo "Remote (B2) snapshots:"
                restic -r "$RESTIC_REPOSITORY_REMOTE" --password-file "$PASSWORD_FILE" snapshots
            else
                echo "Warning: B2 credentials incomplete, cannot list remote snapshots" >&2
            fi
        else
            echo "Warning: B2 credentials file not found, cannot list remote snapshots" >&2
        fi
    fi
    
    if [[ "$ICLOUD" == true ]]; then
        if [[ -d "$ICLOUD_REPO" ]]; then
            verify_icloud_password_key || true
            echo ""
            echo "iCloud snapshots:"
            restic -r "$ICLOUD_REPO" --password-file "$PASSWORD_FILE" snapshots
        else
            echo "Warning: iCloud repository not found at $ICLOUD_REPO, cannot list iCloud snapshots" >&2
        fi
    fi
    exit 0
fi

# Check repository integrity and show stats
if [[ "$CHECK" == true ]]; then
    if [[ "$LOCAL" == true ]]; then
        echo "Checking local repository integrity..."
        restic -r "$LOCAL_REPO" --password-file "$PASSWORD_FILE" check
        
        echo ""
        echo "Local repository statistics:"
        restic -r "$LOCAL_REPO" --password-file "$PASSWORD_FILE" stats latest
    fi
    
    if [[ "$REMOTE" == true ]]; then
        B2_ENV="$HOME/.config/restic/b2-env"
        if [[ -f "$B2_ENV" ]]; then
            source "$B2_ENV"
            if [[ -n "${B2_ACCOUNT_ID:-}" && -n "${B2_ACCOUNT_KEY:-}" && -n "${RESTIC_REPOSITORY_REMOTE:-}" ]]; then
                echo ""
                echo "Checking remote (B2) repository integrity..."
                restic -r "$RESTIC_REPOSITORY_REMOTE" --password-file "$PASSWORD_FILE" check
                
                echo ""
                echo "Remote (B2) repository statistics:"
                restic -r "$RESTIC_REPOSITORY_REMOTE" --password-file "$PASSWORD_FILE" stats latest
            else
                echo "Warning: B2 credentials incomplete, cannot check remote repository" >&2
            fi
        else
            echo "Warning: B2 credentials file not found, cannot check remote repository" >&2
        fi
    fi

    if [[ "$ICLOUD" == true ]]; then
        if [[ -d "$ICLOUD_REPO" ]]; then
            verify_icloud_password_key || true
            echo ""
            echo "Checking iCloud repository integrity..."
            restic -r "$ICLOUD_REPO" --password-file "$PASSWORD_FILE" check

            echo ""
            echo "iCloud repository statistics:"
            restic -r "$ICLOUD_REPO" --password-file "$PASSWORD_FILE" stats latest
        else
            echo "Warning: iCloud repository not found at $ICLOUD_REPO, cannot check iCloud repository" >&2
        fi
    fi
    exit 0
fi

# Ensure log directory exists
mkdir -p "$LOG_DIR"

# Skip backup if one completed within the last 30 seconds (avoids duplicate runs
# when backup-vault.sh wraps both the manual invocation and the MCP server)
LOCK_FILE="$LOG_DIR/vault-backup.lock"
SKIP_BACKUP=false
if [[ -f "$LOCK_FILE" ]]; then
    lock_mtime=$(stat -f %m "$LOCK_FILE" 2>/dev/null) || lock_mtime=0
    lock_mtime=${lock_mtime:-0}
    if [[ "$lock_mtime" =~ ^[0-9]+$ ]]; then
    lock_age=$(( $(date +%s) - lock_mtime ))
    if [[ $lock_age -lt 30 && $lock_age -ge 0 ]]; then
        echo "Backup already ran ${lock_age}s ago, skipping..."
        SKIP_BACKUP=true
    fi
    fi
fi

if [[ "$SKIP_BACKUP" == false ]]; then

BACKUP_OK=false

if [[ "$LOCAL" == true ]]; then
    # Initialize local repo if needed
    if [[ ! -d "$LOCAL_REPO" ]]; then
        echo "Initializing local repository at $LOCAL_REPO"
        restic -r "$LOCAL_REPO" --password-file "$PASSWORD_FILE" init
    fi

    # Run local backup
    echo "Backing up vault to local repository..."
    if run_backup "$LOCAL_REPO" --tag "$TAG"; then
        BACKUP_OK=true
    fi

    # Prune old snapshots (local retention: all within 2h, 24 hourly, 7 daily)
    echo "Pruning old local snapshots..."
    restic -r "$LOCAL_REPO" --password-file "$PASSWORD_FILE" unlock --remove-all 2>/dev/null || true
    restic -r "$LOCAL_REPO" --password-file "$PASSWORD_FILE" forget --retry-lock 2m --keep-within 2h --keep-hourly 24 --keep-daily 7 --prune || true
fi

# iCloud backup
if [[ "$ICLOUD" == true ]]; then
    if [[ -d "$ICLOUD_DIR" ]]; then
        if [[ ! -d "$ICLOUD_REPO" ]]; then
            echo "Initializing iCloud repository at $ICLOUD_REPO"
            mkdir -p "$ICLOUD_REPO"
            restic -r "$ICLOUD_REPO" --password-file "$PASSWORD_FILE" init
        fi

        verify_icloud_password_key || true

        echo "Backing up vault to iCloud repository..."
        if run_backup "$ICLOUD_REPO" --tag "$TAG" --tag "icloud"; then
            BACKUP_OK=true
        fi

        echo "Pruning old iCloud snapshots..."
        restic -r "$ICLOUD_REPO" --password-file "$PASSWORD_FILE" unlock --remove-all 2>/dev/null || true
        restic -r "$ICLOUD_REPO" --password-file "$PASSWORD_FILE" forget --retry-lock 2m --keep-within 2h --keep-hourly 24 --keep-daily 7 --prune || true
    else
        echo "Warning: iCloud backup folder not found at $ICLOUD_DIR, skipping iCloud backup" >&2
    fi
fi

# Remote backup (B2) - placeholder for later
if [[ "$REMOTE" == true ]]; then
    B2_ENV="$HOME/.config/restic/b2-env"
    if [[ -f "$B2_ENV" ]]; then
        source "$B2_ENV"
        if [[ -n "${B2_ACCOUNT_ID:-}" && -n "${B2_ACCOUNT_KEY:-}" && -n "${RESTIC_REPOSITORY_REMOTE:-}" ]]; then
            echo "Backing up to B2..."
            if run_backup "$RESTIC_REPOSITORY_REMOTE" --tag "$TAG" --tag "remote"; then
                BACKUP_OK=true
            fi
            restic -r "$RESTIC_REPOSITORY_REMOTE" --password-file "$PASSWORD_FILE" unlock --remove-all 2>/dev/null || true
            restic -r "$RESTIC_REPOSITORY_REMOTE" --password-file "$PASSWORD_FILE" forget --retry-lock 2m --keep-within 2h --keep-daily 30 --keep-weekly 12 --keep-monthly 12 --prune || true
        else
            echo "Warning: B2 credentials incomplete, skipping remote backup" >&2
        fi
    else
        echo "Warning: B2 credentials file not found at $B2_ENV, skipping remote backup" >&2
    fi
fi

echo "Backup complete."
if [[ "$BACKUP_OK" == true ]]; then
    touch "$LOCK_FILE"
fi

fi # SKIP_BACKUP

# Run command if provided
if [[ ${#COMMAND_ARGS[@]} -gt 0 ]]; then
    echo "Running: ${COMMAND_ARGS[*]}"
    exec "${COMMAND_ARGS[@]}"
fi
